<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriTrack Fun</title>
    <!-- Link to the PWA manifest file -->
    <link rel="manifest" href="/Food-Tracker/manifest.json">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Import a clean, modern font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Styling for the modal and message box UI */
        .message-box, .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            z-index: 1000;
            width: 90%;
            max-width: 400px;
        }
        .message-box-overlay, .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        /* Custom primary button with gradient and hover effect */
        .btn-primary {
            background-image: linear-gradient(to right, #6EE7B7, #34D399, #10B981);
            color: white;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        /* CSS for the circular progress bars */
        .progress-circle {
            transform: rotate(-90deg);
        }
        .progress-circle-bg {
            stroke: #e2e8f0;
        }
        .progress-circle-fg {
            transition: stroke-dashoffset 0.5s ease-in-out;
        }
        /* Calendar cell styling based on nutrition progress */
        .calendar-cell.achieved-100 { background-color: #10B981; color: white; }
        .calendar-cell.achieved-90 { background-color: #A3E635; color: black; }
        .calendar-cell.achieved-70 { background-color: #FACC15; color: black; }
        .calendar-cell.achieved-50 { background-color: #F87171; color: white; }
        .calendar-cell.achieved-25 { background-color: #EF4444; color: white; }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global app ID for Firestore
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // DOM Elements
        const credentialsPage = document.getElementById('credentials-page');
        const loginPage = document.getElementById('login-page');
        const registerPage = document.getElementById('register-page');
        const homePage = document.getElementById('home-page');
        const mainContent = document.getElementById('main-content');
        
        // Credentials page elements
        const nutritionixIdInput = document.getElementById('nutritionix-id-input');
        const nutritionixKeyInput = document.getElementById('nutritionix-key-input');
        const fbApiKeyInput = document.getElementById('fb-api-key-input');
        const fbAuthDomainInput = document.getElementById('fb-auth-domain-input');
        const fbProjectIdInput = document.getElementById('fb-project-id-input');
        const fbStorageBucketInput = document.getElementById('fb-storage-bucket-input');
        const fbMessagingSenderIdInput = document.getElementById('fb-messaging-sender-id-input');
        const fbAppIdInput = document.getElementById('fb-app-id-input');
        const saveCredentialsBtn = document.getElementById('save-credentials-btn');

        // Login & Register page elements
        const loginEmailInput = document.getElementById('login-email-input');
        const loginPasswordInput = document.getElementById('login-password-input');
        const loginBtn = document.getElementById('login-btn');
        const goToRegisterBtn = document.getElementById('go-to-register-btn');
        const registerEmailInput = document.getElementById('register-email-input');
        const registerPasswordInput = document.getElementById('register-password-input');
        const registerBtn = document.getElementById('register-btn');
        const goToLoginBtn = document.getElementById('go-to-login-btn');
        
        // Home page elements
        const foodQueryInput = document.getElementById('food-query-input');
        const searchBtn = document.getElementById('search-btn');
        const resultsContainer = document.getElementById('results-container');
        const addFoodBtn = document.getElementById('add-food-btn');
        const dailyTargetsForm = document.getElementById('daily-targets-form');
        const dailyProgressContainer = document.getElementById('daily-progress-container');
        const dailyEntriesContainer = document.getElementById('daily-entries-container');
        const calendarContainer = document.getElementById('calendar-container');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const currentMonthDisplay = document.getElementById('current-month-display');
        const messageBox = document.getElementById('message-box');
        const messageTitle = document.getElementById('message-title');
        const messageContent = document.getElementById('message-content');
        const closeMessageBtn = document.getElementById('close-message-btn');
        const messageBoxOverlay = document.getElementById('message-box-overlay');
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const userNameDisplay = document.getElementById('user-name-display');
        const logoutBtn = document.getElementById('logout-btn');
        const dailyTargetsToggle = document.getElementById('daily-targets-toggle');
        const dailyTargetsContent = document.getElementById('daily-targets-content');
        
        let db, auth, userId;
        let currentFoodItem = null;
        let currentMonth = new Date();

        // Helper Functions for UI
        const showView = (view) => {
            const views = [credentialsPage, loginPage, registerPage, homePage];
            views.forEach(v => v.classList.add('hidden'));
            view.classList.remove('hidden');
        };

        const showMessageBox = (title, content) => {
            messageTitle.textContent = title;
            messageContent.textContent = content;
            messageBox.classList.remove('hidden');
            messageBoxOverlay.classList.remove('hidden');
        };

        const hideMessageBox = () => {
            messageBox.classList.add('hidden');
            messageBoxOverlay.classList.add('hidden');
        };
        
        const showModal = (content) => {
            modalContent.innerHTML = content;
            modal.classList.remove('hidden');
            document.getElementById('modal-overlay').classList.remove('hidden');
        };

        const hideModal = () => {
            modal.classList.add('hidden');
            document.getElementById('modal-overlay').classList.add('hidden');
        };

        // Event listeners for modals
        closeMessageBtn.addEventListener('click', hideMessageBox);
        messageBoxOverlay.addEventListener('click', hideMessageBox);
        closeModalBtn.addEventListener('click', hideModal);
        
        // Event listener for the daily targets dropdown
        dailyTargetsToggle.addEventListener('click', () => {
            dailyTargetsContent.classList.toggle('hidden');
            dailyTargetsToggle.querySelector('i').classList.toggle('rotate-180');
        });

        // Firestore Functions
        const getUserRef = (uid) => doc(db, 'artifacts', appId, 'users', uid);
        const getDailyEntriesRef = (uid) => collection(db, 'artifacts', appId, 'users', uid, 'dailyEntries');

        // Main app initialization function
        const initApp = () => {
            // Check for credentials in localStorage
            const nutritionixKeys = JSON.parse(localStorage.getItem('nutritionix_keys'));
            const firebaseConfig = JSON.parse(localStorage.getItem('firebase_config'));
            
            if (nutritionixKeys && firebaseConfig) {
                // Initialize Firebase with user-provided config
                try {
                    const firebaseApp = initializeApp(firebaseConfig);
                    auth = getAuth(firebaseApp);
                    db = getFirestore(firebaseApp);

                    // Setup authentication state listener
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            // User is signed in.
                            userId = user.uid;
                            showView(homePage);
                            setupRealtimeListeners();
                            renderCalendar();
                        } else {
                            // User is signed out, show the login page
                            userId = null;
                            userNameDisplay.textContent = '';
                            showView(loginPage);
                        }
                    });

                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    showMessageBox('Initialization Error', `Failed to initialize Firebase. Error: ${error.message}. Please check your config and try again.`);
                    showView(credentialsPage);
                }
            } else {
                // Show credentials page if any keys are missing
                showView(credentialsPage);
            }
        };

        // API Credential Saving Logic
        saveCredentialsBtn.addEventListener('click', () => {
            const nutritionixId = nutritionixIdInput.value.trim();
            const nutritionixKey = nutritionixKeyInput.value.trim();
            
            // New logic to create firebase config from individual fields
            const firebaseConfig = {
                apiKey: fbApiKeyInput.value.trim(),
                authDomain: fbAuthDomainInput.value.trim(),
                projectId: fbProjectIdInput.value.trim(),
                storageBucket: fbStorageBucketInput.value.trim(),
                messagingSenderId: fbMessagingSenderIdInput.value.trim(),
                appId: fbAppIdInput.value.trim()
            };

            if (!nutritionixId || !nutritionixKey || Object.values(firebaseConfig).some(val => !val)) {
                showMessageBox('Error', 'All fields are required. Please enter your credentials.');
                return;
            }
            
            try {
                localStorage.setItem('nutritionix_keys', JSON.stringify({ appId: nutritionixId, apiKey: nutritionixKey }));
                localStorage.setItem('firebase_config', JSON.stringify(firebaseConfig));
                showMessageBox('Success', 'Credentials saved! You can now log in.');
                
                // Re-initialize the app with the new credentials
                initApp(); 

            } catch (error) {
                showMessageBox('Error', 'Failed to save credentials. Please check your inputs.');
            }
        });
        
        // --- AUTHENTICATION FLOW LOGIC (UPDATED FOR EMAIL/PASSWORD) ---

        // Navigate from Login to Register
        goToRegisterBtn.addEventListener('click', () => {
            showView(registerPage);
        });

        // Navigate from Register to Login
        goToLoginBtn.addEventListener('click', () => {
            showView(loginPage);
        });

        // Login with email and password
        loginBtn.addEventListener('click', async () => {
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value.trim();
            if (!email || !password) {
                showMessageBox('Error', 'Please enter both email and password.');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged listener will handle the transition to the home page
            } catch (error) {
                console.error("Firebase sign-in failed:", error);
                showMessageBox('Authentication Error', `Failed to sign in. Error: ${error.message}.`);
            }
        });
        
        // Register new user with email and password
        registerBtn.addEventListener('click', async () => {
            const email = registerEmailInput.value.trim();
            const password = registerPasswordInput.value.trim();
            
            if (!email || !password) {
                showMessageBox('Error', 'Please fill in all fields (Email, and Password).');
                return;
            }

            try {
                // Create the user with email and password
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const uid = userCredential.user.uid;
                
                // Automatically set the username from the email prefix
                const userName = email.split('@')[0];
                const userDocRef = getUserRef(uid);
                await setDoc(userDocRef, { userName: userName }, { merge: true });
                
                // onAuthStateChanged listener will handle the transition to the home page
                showMessageBox('Success', 'Registration complete! Welcome to NutriTrack Fun.');

            } catch (error) {
                showMessageBox('Error', `Failed to register. Error: ${error.message}`);
                console.error("Error during registration:", error);
            }
        });

        // Logout functionality
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // The onAuthStateChanged listener will handle redirecting to the login page
            } catch (error) {
                console.error("Error signing out:", error);
                showMessageBox('Logout Error', `Failed to log out. Error: ${error.message}`);
            }
        });
        
        // Save Daily Targets
        dailyTargetsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) {
                showMessageBox('Error', 'User not authenticated.');
                return;
            }
            const targets = {
                calories: parseFloat(e.target['target-calories'].value) || 0,
                protein: parseFloat(e.target['target-protein'].value) || 0,
                carbs: parseFloat(e.target['target-carbs'].value) || 0,
                sugar: parseFloat(e.target['target-sugar'].value) || 0,
                fiber: parseFloat(e.target['target-fiber'].value) || 0,
                satFat: parseFloat(e.target['target-satFat'].value) || 0,
                sodium: parseFloat(e.target['target-sodium'].value) || 0,
                potassium: parseFloat(e.target['target-potassium'].value) || 0,
                fat: parseFloat(e.target['target-fat'].value) || 0
            };
            try {
                const userDocRef = getUserRef(userId);
                await setDoc(userDocRef, { dailyTargets: targets }, { merge: true });
                showMessageBox('Success', 'Daily targets saved!');
            } catch (error) {
                showMessageBox('Error', 'Failed to save targets.');
                console.error("Error saving daily targets:", error);
            }
        });

        // Nutritionix API Logic
        searchBtn.addEventListener('click', async () => {
            const query = foodQueryInput.value.trim();
            if (!query) {
                showMessageBox('Input Required', 'Please enter a food item to search.');
                return;
            }

            const keys = JSON.parse(localStorage.getItem('nutritionix_keys'));
            if (!keys || !keys.appId || !keys.apiKey) {
                showMessageBox('Credentials Missing', 'Please go to the credentials page to enter your API keys.');
                return;
            }
            
            // Show loading state
            searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-white"></i>';
            searchBtn.disabled = true;

            try {
                const apiUrl = 'https://trackapi.nutritionix.com/v2/natural/nutrients';
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'x-app-id': keys.appId,
                        'x-app-key': keys.apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `API error: ${response.statusText}`);
                }

                const data = await response.json();
                displaySearchResults(data);

            } catch (error) {
                showMessageBox('Search Error', `Failed to fetch data: ${error.message}`);
                console.error("Error fetching data:", error);
            } finally {
                searchBtn.innerHTML = '<i class="fas fa-search"></i>';
                searchBtn.disabled = false;
            }
        });

        // Display search results
        const displaySearchResults = (data) => {
            if (!data.foods || data.foods.length === 0) {
                resultsContainer.innerHTML = '<p class="text-center text-gray-500">No results found.</p>';
                addFoodBtn.classList.add('hidden');
                return;
            }
            
            currentFoodItem = data.foods[0];
            const food = currentFoodItem;

            let html = `
                <div class="bg-white p-4 rounded-xl shadow-md">
                    <h3 class="font-bold text-lg mb-2">${food.food_name}</h3>
                    <p class="text-gray-500 text-sm mb-4">Serving: ${food.serving_qty} ${food.serving_unit} (${food.serving_weight_grams}g)</p>
                    <div class="grid grid-cols-3 gap-3 text-center">
                        <div class="bg-indigo-100 p-3 rounded-lg shadow-sm">
                            <p class="text-xl font-bold text-indigo-700">${food.nf_calories ? food.nf_calories.toFixed(1) : '0'}</p>
                            <p class="text-xs font-medium text-indigo-500">Calories (kcal)</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-lg shadow-sm">
                            <p class="text-xl font-bold text-green-700">${food.nf_protein ? food.nf_protein.toFixed(1) : '0'}</p>
                            <p class="text-xs font-medium text-green-500">Protein (g)</p>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-lg shadow-sm">
                            <p class="text-xl font-bold text-yellow-700">${food.nf_total_fat ? food.nf_total_fat.toFixed(1) : '0'}</p>
                            <p class="text-xs font-medium text-yellow-500">Fat (g)</p>
                        </div>
                        <div class="bg-red-100 p-3 rounded-lg shadow-sm">
                            <p class="text-xl font-bold text-red-700">${food.nf_total_carbohydrate ? food.nf_total_carbohydrate.toFixed(1) : '0'}</p>
                            <p class="text-xs font-medium text-red-500">Carbohydrates (g)</p>
                        </div>
                        <div class="bg-pink-100 p-3 rounded-lg shadow-sm">
                            <p class="text-xl font-bold text-pink-700">${food.nf_sugars ? food.nf_sugars.toFixed(1) : '0'}</p>
                            <p class="text-xs font-medium text-pink-500">Sugar (g)</p>
                        </div>
                        <div class="bg-cyan-100 p-3 rounded-lg shadow-sm">
                            <p class="text-xl font-bold text-cyan-700">${food.nf_dietary_fiber ? food.nf_dietary_fiber.toFixed(1) : '0'}</p>
                            <p class="text-xs font-medium text-cyan-500">Fiber (g)</p>
                        </div>
                        <div class="bg-orange-100 p-3 rounded-lg shadow-sm">
                            <p class="text-xl font-bold text-orange-700">${food.nf_sodium ? food.nf_sodium.toFixed(1) : '0'}</p>
                            <p class="text-xs font-medium text-orange-500">Sodium (mg)</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-lg shadow-sm">
                            <p class="text-xl font-bold text-purple-700">${food.nf_saturated_fat ? food.nf_saturated_fat.toFixed(1) : '0'}</p>
                            <p class="text-xs font-medium text-purple-500">Saturated Fat (g)</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-lg shadow-sm">
                            <p class="text-xl font-bold text-blue-700">${food.nf_potassium ? food.nf_potassium.toFixed(1) : '0'}</p>
                            <p class="text-xs font-medium text-blue-500">Potassium (mg)</p>
                        </div>
                    </div>
                </div>
            `;
            resultsContainer.innerHTML = html;
            addFoodBtn.classList.remove('hidden');
        };

        // Add food item to daily log
        addFoodBtn.addEventListener('click', async () => {
            if (!currentFoodItem || !userId) return;

            const today = new Date();
            const dateStr = today.toISOString().slice(0, 10);
            const foodEntry = {
                ...currentFoodItem,
                timestamp: new Date().toISOString(),
            };
            
            try {
                const dailyEntriesRef = getDailyEntriesRef(userId);
                const dailyEntryDocRef = doc(dailyEntriesRef, dateStr);
                const dailyEntryDoc = await getDoc(dailyEntryDocRef);

                let updatedEntries = [];
                if (dailyEntryDoc.exists()) {
                    const existingData = dailyEntryDoc.data();
                    updatedEntries = [...existingData.foods, foodEntry];
                } else {
                    updatedEntries.push(foodEntry);
                }

                await setDoc(dailyEntryDocRef, {
                    foods: updatedEntries,
                }, { merge: true });
                
                showMessageBox('Success', `${currentFoodItem.food_name} added to your log for today!`);
                foodQueryInput.value = '';
                resultsContainer.innerHTML = '';
                addFoodBtn.classList.add('hidden');

            } catch (error) {
                showMessageBox('Error', 'Failed to add food entry.');
                console.error("Error adding food entry:", error);
            }
        });
        
        // Setup Firestore listeners for real-time updates
        const setupRealtimeListeners = () => {
            if (!userId) return;

            // Listen for user targets and name
            const userDocRef = getUserRef(userId);
            onSnapshot(userDocRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    if (data.dailyTargets) {
                        const targets = data.dailyTargets;
                        document.getElementById('target-calories').value = targets.calories;
                        document.getElementById('target-protein').value = targets.protein;
                        document.getElementById('target-carbs').value = targets.carbs;
                        document.getElementById('target-sugar').value = targets.sugar;
                        document.getElementById('target-fiber').value = targets.fiber;
                        document.getElementById('target-satFat').value = targets.satFat;
                        document.getElementById('target-sodium').value = targets.sodium;
                        document.getElementById('target-potassium').value = targets.potassium;
                        document.getElementById('target-fat').value = targets.fat;
                    }
                    if (data.userName) {
                        userNameDisplay.textContent = data.userName;
                    } else {
                        userNameDisplay.textContent = 'User';
                    }
                }
            }, (error) => {
                console.error("Error getting user data:", error);
            });

            // Listen for today's entries
            const today = new Date().toISOString().slice(0, 10);
            const todayEntryRef = doc(getDailyEntriesRef(userId), today);
            onSnapshot(todayEntryRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    updateDailyProgress(data);
                } else {
                    updateDailyProgress({ foods: [] });
                }
            }, (error) => {
                console.error("Error getting today's entries:", error);
            });

            // Listen for all entries for the calendar and recent logs
            const allEntriesQuery = query(getDailyEntriesRef(userId));
            onSnapshot(allEntriesQuery, (snapshot) => {
                const allEntries = {};
                snapshot.forEach(doc => {
                    allEntries[doc.id] = doc.data();
                });
                displayRecentEntries(allEntries);
                renderCalendarWithData(allEntries);
            }, (error) => {
                console.error("Error getting all entries:", error);
            });
        };
        
        // Update the daily progress circles
        const updateDailyProgress = async (data) => {
            const userDoc = await getDoc(getUserRef(userId));
            const targets = userDoc.exists() ? userDoc.data().dailyTargets || {} : {};
        
            const totals = data.foods.reduce((acc, food) => {
                acc.calories += food.nf_calories || 0;
                acc.protein += food.nf_protein || 0;
                acc.fat += food.nf_total_fat || 0;
                acc.carbs += food.nf_total_carbohydrate || 0;
                acc.sugar += food.nf_sugars || 0;
                acc.fiber += food.nf_dietary_fiber || 0;
                acc.sodium += food.nf_sodium || 0;
                acc.satFat += food.nf_saturated_fat || 0;
                acc.potassium += food.nf_potassium || 0;
                return acc;
            }, { calories: 0, protein: 0, fat: 0, carbs: 0, sugar: 0, fiber: 0, sodium: 0, satFat: 0, potassium: 0 });

            const nutrients = ['calories', 'protein', 'fat', 'carbs', 'sugar', 'fiber', 'sodium', 'satFat', 'potassium'];
            dailyProgressContainer.innerHTML = '';
            nutrients.forEach(nutrient => {
                const target = targets[nutrient] || 1;
                const current = totals[nutrient] || 0;
                const percentage = Math.min(100, (current / target) * 100);
                
                let title = '';
                let unit = '';
                let colorClass = '';
                let color = '';

                switch (nutrient) {
                    case 'calories': title = 'Calories'; unit = 'kcal'; colorClass = 'text-indigo-600'; color = '#4F46E5'; break;
                    case 'protein': title = 'Protein'; unit = 'g'; colorClass = 'text-green-600'; color = '#10B981'; break;
                    case 'fat': title = 'Fat'; unit = 'g'; colorClass = 'text-yellow-600'; color = '#EAB308'; break;
                    case 'carbs': title = 'Carbohydrates'; unit = 'g'; colorClass = 'text-red-600'; color = '#EF4444'; break;
                    case 'sugar': title = 'Sugar'; unit = 'g'; colorClass = 'text-pink-600'; color = '#EC4899'; break;
                    case 'fiber': title = 'Fiber'; unit = 'g'; colorClass = 'text-cyan-600'; color = '#06B6D4'; break;
                    case 'sodium': title = 'Sodium'; unit = 'mg'; colorClass = 'text-orange-600'; color = '#F97316'; break;
                    case 'satFat': title = 'Saturated Fat'; unit = 'g'; colorClass = 'text-purple-660'; color = '#9333EA'; break;
                    case 'potassium': title = 'Potassium'; unit = 'mg'; colorClass = 'text-blue-600'; color = '#3B82F6'; break;
                }

                const svgHtml = `
                    <div class="flex flex-col items-center p-2 bg-white rounded-xl shadow-md">
                        <div class="relative w-16 h-16">
                            <svg class="progress-circle absolute top-0 left-0" viewBox="0 0 36 36">
                                <circle class="progress-circle-bg" cx="18" cy="18" r="16" fill="none" stroke-width="4"></circle>
                                <circle class="progress-circle-fg" cx="18" cy="18" r="16" fill="none" stroke="${color}" stroke-width="4" stroke-dasharray="100" stroke-dashoffset="${100 - percentage}"></circle>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center flex-col">
                                <p class="text-md font-bold ${colorClass}">${current.toFixed(0)}</p>
                                <p class="text-xs text-gray-500">${unit}</p>
                            </div>
                        </div>
                        <p class="mt-1 text-xs font-medium text-gray-700">${title}</p>
                    </div>
                `;
                dailyProgressContainer.innerHTML += svgHtml;
            });
        };

        // Helper function to create the progress circle SVG for the modal/recent entries
        const createNutrientCircles = (food) => {
            return `
                <div class="grid grid-cols-4 gap-2 text-center">
                    ${createSingleCircle(food.nf_calories || 0, 'kcal', 'Cal', 'text-indigo-600', '#4F46E5', 500)}
                    ${createSingleCircle(food.nf_protein || 0, 'g', 'Pro', 'text-green-600', '#10B981', 100)}
                    ${createSingleCircle(food.nf_total_carbohydrate || 0, 'g', 'Carb', 'text-red-600', '#EF4444', 100)}
                    ${createSingleCircle(food.nf_total_fat || 0, 'g', 'Fat', 'text-yellow-600', '#EAB308', 100)}
                </div>
            `;
        };

        const createSingleCircle = (value, unit, label, colorClass, color, maxValue) => {
            const size = 12; 
            const circumference = 2 * Math.PI * (size - 2); 
            const percentage = Math.min(100, (value / maxValue) * 100); 
            const offset = circumference - percentage / 100 * circumference;
            
            return `
                <div class="flex flex-col items-center">
                    <div class="relative w-12 h-12">
                        <svg class="progress-circle absolute top-0 left-0" viewBox="0 0 24 24">
                            <circle class="progress-circle-bg" cx="12" cy="12" r="10" fill="none" stroke-width="2"></circle>
                            <circle class="progress-circle-fg" cx="12" cy="12" r="10" fill="none" stroke="${color}" stroke-width="2" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"></circle>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center flex-col">
                            <p class="text-xs font-bold ${colorClass}">${value.toFixed(0)}</p>
                            <p class="text-xs text-gray-500">${unit}</p>
                        </div>
                    </div>
                    <p class="mt-1 text-xs font-medium text-gray-700">${label}</p>
                </div>
            `;
        };

        // Display recent entries as collapsible dropdowns
        const displayRecentEntries = (allEntries) => {
            const sortedDates = Object.keys(allEntries).sort((a, b) => new Date(b) - new Date(a));
            const recentDates = sortedDates.slice(0, 5);

            dailyEntriesContainer.innerHTML = '';
            
            recentDates.forEach(date => {
                const entry = allEntries[date];
                const dateObj = new Date(date + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

                const totalCalories = entry.foods.reduce((sum, food) => sum + (food.nf_calories || 0), 0);

                let foodListHtml = '';
                entry.foods.forEach(food => {
                    foodListHtml += `
                        <div class="flex flex-col bg-gray-50 p-3 rounded-lg shadow-sm border-b-2 border-gray-100 last:border-b-0">
                            <p class="text-sm font-semibold text-gray-800 mb-2">${food.food_name}</p>
                            ${createNutrientCircles(food)}
                        </div>
                    `;
                });

                const dropdownHtml = `
                    <div class="bg-white rounded-xl shadow-md p-4 mb-3 cursor-pointer" data-dropdown-date="${date}">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-gray-800">${formattedDate}</p>
                                <p class="text-sm text-gray-500">${totalCalories.toFixed(0)} total calories</p>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 transform transition-transform duration-200"></i>
                        </div>
                        <div class="dropdown-content hidden mt-3 space-y-2">
                            ${foodListHtml}
                        </div>
                    </div>
                `;
                dailyEntriesContainer.innerHTML += dropdownHtml;
            });

            // Add event listeners for dropdowns
            dailyEntriesContainer.querySelectorAll('[data-dropdown-date]').forEach(dropdown => {
                dropdown.addEventListener('click', (e) => {
                    e.currentTarget.querySelector('.dropdown-content').classList.toggle('hidden');
                    e.currentTarget.querySelector('.fa-chevron-down').classList.toggle('rotate-180');
                });
            });
        };

        // Calendar logic
        const renderCalendar = () => {
            // Re-fetch all entries when the month changes to update the calendar
            onSnapshot(query(getDailyEntriesRef(userId)), (snapshot) => {
                const allEntries = {};
                snapshot.forEach(doc => {
                    allEntries[doc.id] = doc.data();
                });
                renderCalendarWithData(allEntries);
            });
        };

        const renderCalendarWithData = async (allEntries) => {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            currentMonthDisplay.textContent = new Date(year, month).toLocaleString('en-US', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const lastDayOfMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date().toISOString().slice(0, 10);
            
            const userDoc = await getDoc(getUserRef(userId));
            const targets = userDoc.exists() ? userDoc.data().dailyTargets || {} : {};
            const targetCalories = targets.calories || 1;

            let cells = '';
            for (let i = 0; i < firstDayOfMonth; i++) {
                cells += '<div></div>';
            }

            for (let day = 1; day <= lastDayOfMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const entry = allEntries[dateStr];
                let progressClass = '';
                let totalCalories = 0;

                if (entry) {
                    totalCalories = entry.foods.reduce((sum, food) => sum + (food.nf_calories || 0), 0);
                    const percentage = (totalCalories / targetCalories) * 100;
                    
                    if (percentage >= 100) progressClass = 'achieved-100';
                    else if (percentage >= 90) progressClass = 'achieved-90';
                    else if (percentage >= 70) progressClass = 'achieved-70';
                    else if (percentage >= 50) progressClass = 'achieved-50';
                    else progressClass = 'achieved-25';
                }

                const isToday = dateStr === today;
                const borderClass = isToday ? 'border-none' : 'border-none';

                cells += `
                    <div class="calendar-cell w-8 h-8 md:w-10 md:h-10 flex items-center justify-center text-sm rounded-lg cursor-pointer ${progressClass} ${borderClass}" data-date="${dateStr}" data-calories="${totalCalories}">
                        ${day}
                    </div>
                `;
            }
            calendarContainer.innerHTML = cells;
            
            // Add click listeners to calendar cells
            calendarContainer.querySelectorAll('.calendar-cell').forEach(cell => {
                cell.addEventListener('click', () => {
                    const date = cell.dataset.date;
                    const entry = allEntries[date];
                    let modalHtml = `<h3 class="text-xl font-bold mb-4">Entries for ${date}</h3>`;
                    
                    if (entry && entry.foods.length > 0) {
                        modalHtml += `<div class="space-y-4">`;
                        entry.foods.forEach(food => {
                            // Generate the new circular display for each food item
                            const foodCircles = `
                                <div class="bg-gray-50 rounded-xl shadow-sm">
                                    <p class="font-semibold text-gray-800 mb-2">${food.food_name}</p>
                                    ${createNutrientCircles(food)}
                                </div>
                            `;
                            modalHtml += foodCircles;
                        });
                        modalHtml += `</div>`;
                    } else {
                        modalHtml += `<p class="text-gray-600">No entries for this day.</p>`;
                    }
                    
                    showModal(modalHtml);
                });
            });
        };

        prevMonthBtn.addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderCalendar();
        });

        // Start the app logic
        initApp();
        
    </script>

    <!-- App Views -->
    <div id="main-content" class="flex-grow flex flex-col justify-center items-center">

        <!-- API & Firebase Credentials Setup Page -->
        <div id="credentials-page" class="w-full max-w-lg bg-white rounded-2xl shadow-xl p-8 hidden">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Setup Credentials</h1>
                <p class="text-gray-500">Please provide your API keys and Firebase config to get started.</p>
            </div>
            <div class="space-y-6">
                <!-- Nutritionix API Keys Section -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">Nutritionix API Keys</h2>
                    <input type="text" id="nutritionix-id-input" placeholder="Nutritionix App ID" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400 mb-2">
                    <input type="text" id="nutritionix-key-input" placeholder="Nutritionix API Key" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400">
                </div>
                <!-- Firebase Config Section -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">Firebase Config</h2>
                    <input type="text" id="fb-api-key-input" placeholder="apiKey" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400 mb-2">
                    <input type="text" id="fb-auth-domain-input" placeholder="authDomain" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400 mb-2">
                    <input type="text" id="fb-project-id-input" placeholder="projectId" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400 mb-2">
                    <input type="text" id="fb-storage-bucket-input" placeholder="storageBucket" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400 mb-2">
                    <input type="text" id="fb-messaging-sender-id-input" placeholder="messagingSenderId" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400 mb-2">
                    <input type="text" id="fb-app-id-input" placeholder="appId" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400">
                </div>
                <button id="save-credentials-btn" class="w-full mt-4 py-3 rounded-xl font-bold btn-primary">
                    Save Credentials
                </button>
            </div>
        </div>

        <!-- Login Page (Updated for Email/Password) -->
        <div id="login-page" class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-8 hidden">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Welcome Back!</h1>
                <p class="text-gray-500">Sign in to continue.</p>
            </div>
            <div class="space-y-4">
                <input type="email" id="login-email-input" placeholder="Email Address" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400">
                <input type="password" id="login-password-input" placeholder="Password" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400">
                <button id="login-btn" class="w-full py-3 rounded-xl font-bold btn-primary">
                    Sign In
                </button>
                <button id="go-to-register-btn" class="w-full py-3 rounded-xl font-bold bg-gray-200 text-gray-800">
                    New User? Register here
                </button>
            </div>
        </div>
        
        <!-- Register Page (Updated for Email/Password) -->
        <div id="register-page" class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-8 hidden">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Create Account</h1>
                <p class="text-gray-500">Enter your details to get started.</p>
            </div>
            <div class="space-y-4">
                <input type="email" id="register-email-input" placeholder="Email Address" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400">
                <input type="password" id="register-password-input" placeholder="Password" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400">
                <button id="register-btn" class="w-full py-3 rounded-xl font-bold btn-primary">
                    Register and Sign In
                </button>
                <button id="go-to-login-btn" class="w-full py-3 rounded-xl font-bold text-gray-600 hover:underline">
                    Already have an account? Sign in.
                </button>
            </div>
        </div>

        <!-- Main Home Page (hidden initially) -->
        <div id="home-page" class="w-full flex-grow hidden flex flex-col items-center p-4 md:p-8">
            <header class="w-full max-w-4xl flex flex-col md:flex-row justify-between mb-6 space-y-4 md:space-y-0">
                <h1 class="text-3xl font-bold text-gray-800">NutriTrack Fun</h1>
                <div class="flex justify-end space-x-6 !-mt-0">
                    <div class="flex items-center text-sm p-2">
                        <i class="fas fa-user-circle text-gray-400 mr-2"></i>
                        <p id="user-name-display" class="text-gray-600 font-bold">User</p>
                    </div>
                    <button id="logout-btn" class=" text-sm rounded-xl font-bold transition-colors">
                        <img class="w-8 " src="/icons/sign-out.png" alt="logout">
                    </button>
                </div>
            </header>

            <!-- Main Grid Layout -->
            <div class="w-full max-w-4xl grid grid-cols-1 lg:grid-cols-2 gap-6">

                <!-- Column 1: Daily Progress & Search -->
                <div class="flex flex-col space-y-6">
                    <!-- Daily Progress -->
                    <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6">
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Today's Progress</h2>
                        <div id="daily-progress-container" class="grid grid-cols-3 md:grid-cols-3 gap-2 md:gap-4">
                            <!-- Progress circles will be injected here by JS -->
                        </div>
                    </div>

                    <!-- Food Search -->
                    <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6">
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Log a Meal</h2>
                        <div class="flex items-center space-x-2 mb-4">
                            <input type="text" id="food-query-input" placeholder="e.g. 1 bowl of oatmeal, 2 eggs" class="flex-grow px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400">
                            <button id="search-btn" class="w-12 h-12 flex items-center justify-center rounded-xl btn-primary">
                                <i class="fas fa-search text-white"></i>
                            </button>
                        </div>
                        <div id="results-container" class="mb-4">
                            <!-- Search results will be displayed here -->
                        </div>
                        <button id="add-food-btn" class="w-full py-3 rounded-xl font-bold btn-primary hidden">
                            <i class="fas fa-plus mr-2"></i> Add to Today's Log
                        </button>
                    </div>
                </div>

                <!-- Column 2: Calendar & Targets -->
                <div class="flex flex-col space-y-6">
                    
                    <!-- Monthly Calendar -->
                    <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6">
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-month-btn" class="text-gray-500 hover:text-green-500 transition-colors"><i class="fas fa-chevron-left"></i></button>
                            <h3 id="current-month-display" class="text-lg font-semibold text-gray-800"></h3>
                            <button id="next-month-btn" class="text-gray-500 hover:text-green-500 transition-colors"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="grid grid-cols-7 text-center font-medium text-gray-500 mb-2 text-xs md:text-sm">
                            <span>Sun</span>
                            <span>Mon</span>
                            <span>Tue</span>
                            <span>Wed</span>
                            <span>Thu</span>
                            <span>Fri</span>
                            <span>Sat</span>
                        </div>
                        <div id="calendar-container" class="grid grid-cols-7 gap-1">
                            <!-- Calendar cells will be injected here -->
                        </div>
                    </div>
                    
                    <!-- Recent Entries -->
                    <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6">
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Recent Entries</h2>
                        <div id="daily-entries-container" class="space-y-3">
                            <!-- Recent entries will be injected here by JS -->
                        </div>
                    </div>

                    <!-- Daily Targets as a collapsible dropdown -->
                    <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6">
                        <div id="daily-targets-toggle" class="flex justify-between items-center cursor-pointer">
                            <h2 class="text-xl md:text-2xl font-bold text-gray-800">Daily Targets</h2>
                            <i class="fas fa-chevron-down text-gray-400 transform transition-transform duration-200"></i>
                        </div>
                        <div id="daily-targets-content" class="hidden mt-4">
                            <form id="daily-targets-form" class="space-y-4">
                                <div>
                                    <label for="target-calories" class="block text-sm font-medium text-gray-700">Calories (kcal)</label>
                                    <input type="number" id="target-calories" name="target-calories" class="w-full mt-1 px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400">
                                </div>
                                <div>
                                    <label for="target-protein" class="block text-sm font-medium text-gray-700">Protein (g)</label>
                                    <input type="number" id="target-protein" name="target-protein" class="w-full mt-1 px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400">
                                </div>
                                <div>
                                    <label for="target-carbs" class="block text-sm font-medium text-gray-700">Carbohydrates (g)</label>
                                    <input type="number" id="target-carbs" name="target-carbs" class="w-full mt-1 px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400">
                                </div>
                                <div>
                                    <label for="target-sugar" class="block text-sm font-medium text-gray-700">Sugar (g)</label>
                                    <input type="number" id="target-sugar" name="target-sugar" class="w-full mt-1 px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400">
                                </div>
                                <div>
                                    <label for="target-fiber" class="block text-sm font-medium text-gray-700">Fiber (g)</label>
                                    <input type="number" id="target-fiber" name="target-fiber" class="w-full mt-1 px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400">
                                </div>
                                <div>
                                    <label for="target-satFat" class="block text-sm font-medium text-gray-700">Saturated Fat (g)</label>
                                    <input type="number" id="target-satFat" name="target-satFat" class="w-full mt-1 px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400">
                                </div>
                                <div>
                                    <label for="target-sodium" class="block text-sm font-medium text-gray-700">Sodium (mg)</label>
                                    <input type="number" id="target-sodium" name="target-sodium" class="w-full mt-1 px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400">
                                </div>
                                <div>
                                    <label for="target-potassium" class="block text-sm font-medium text-gray-700">Potassium (mg)</label>
                                    <input type="number" id="target-potassium" name="target-potassium" class="w-full mt-1 px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400">
                                </div>
                                <div>
                                    <label for="target-fat" class="block text-sm font-medium text-gray-700">Fat (g)</label>
                                    <input type="number" id="target-fat" name="target-fat" class="w-full mt-1 px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400">
                                </div>
                                <button type="submit" class="w-full py-3 rounded-xl font-bold btn-primary">
                                    Save Targets
                                </button>
                            </form>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>

    </div>

    <!-- Modals and Overlays -->
    <div id="message-box-overlay" class="message-box-overlay hidden"></div>
    <div id="message-box" class="message-box hidden">
        <h3 id="message-title" class="font-bold text-xl mb-2"></h3>
        <p id="message-content" class="text-gray-600 mb-4"></p>
        <button id="close-message-btn" class="w-full py-2 rounded-xl bg-green-500 text-white font-bold">OK</button>
    </div>

    <div id="modal-overlay" class="modal-overlay hidden"></div>
    <div id="modal" class="modal hidden">
        <div id="modal-content"></div>
        <button id="close-modal-btn" class="w-full py-2 mt-4 rounded-xl bg-green-500 text-white font-bold">Close</button>
    </div>
    
    <!-- Script to register the service worker -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/Food-Tracker/service-worker.js').then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, err => {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }
    </script>
</body>
</html>
